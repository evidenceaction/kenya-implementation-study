---
title: "Non-experimental Evaluation of the Impact of Deworming on School Attendance"
output: pdf_document
bibliography: ~/Documents/library.bib
---

```{r, include=FALSE, results="hide"} 
library(car)
library(ggplot2)
library(plyr)
library(dplyr)
library(magrittr)

load("cleaned_sth.RData")

# knitr::opts_chunk$set(cache=TRUE)
options(contrasts=c("contr.Treatment", getOption("contrasts")[2]))
```

```{r, include=FALSE}
predict.rob <- function(x, vcov.=vcov(x), newdata) {
  if (missing(newdata)) { 
    newdata <- x$model 
  }
  
  m.mat <- x %>% 
    terms %>% 
    drop.terms(attr(., "term.labels") %in% names(newdata) %>% not %>% which, keep.response=FALSE) %>%
    model.matrix(data=newdata)
  
  vcov. %<>% (l(vc ~ {
    used.terms <- colnames(vc) %>% sub("\\[.+", "", .) %in% c(names(newdata), "(Intercept)")
    vc[used.terms, used.terms]
  }))
  
  return(list(fit=m.mat %*% (x$coef %>% extract(names(.) %>% sub("\\[.+", "", .) %in% c(names(newdata), "(Intercept)"))),
              se.fit=(m.mat %*% vcov. %*% t(m.mat)) %>% diag %>% sqrt))
}
```

Evidence Action continues to investigate the effect of deworming on school outcomes, as first studied by @Miguel2004 in Kenya.  However, because of practical and ethical obstracles it is no longer feasible to replicate the original randomized experiment.  Thus we are looking for non-experimental strategies to answer the following questions:

1. _How is the school attendance of school-aged children (SAC) impacted by deworming?_  This is a straightforward intention-to-treat (ITT) analysis. 
2. _What is the effect of deworming on the school attendance of SAC who are vulnerable to moderate to high levels of worm infection?_ This is alocal average treatment effects (LATE) analysis, focusing on the latent subpopulation that most in need of deworming [@Imbens1994].

The elimination breakpoint study to be carried out by the London School of Hygiene and Tropical Medicine (LSHTM) presents a valuable opportunity to answer these questions, exploiting the randomized manipulation of reinfection rates.  At the same point of time---because of the greater frequency of deworming in one arm, and the wider deworming of the whole community in another arm---SAC be at risk of randomly varying levels of infection intensity.  Therefore, if reinfection is rapid enough within the standard annual deworming cycle we would have comparable groups of SAC.

To clarify our identification strategy we will adopt a potential outcomes framework.  First, let the variable $Z_j$ be an indicator of whether cluster $j$ has been recently dewormed; $H_{ij}$ be an indicator of whether child $i$ has low or no infection; and $Y_{ij}$ be an indicator of whether child $i$ was present at school at survey time.  Let $H_{ij}(z)$ be potential health status when $Z_{j} = z$, and $Y_{ij}(z, h)$ be potential school attendance when $Z_{ij} = z$ and $H_{ij} = h$^[For simplicity, we combine the biannual and community-based deworming arms, and assume that health and school attendance status are binary.].

To answer our first research question and estimate the ITT effect, we compare school attendance of children, nine months after the first deworming, so that some clusters would have been dewormed three months ago (treatment) and others nine months ago (control):
$$
 ITT = E[Y_{ij}(1, H_{ij}(1)) - Y_{ij}(0, H_{ij}(0))] = E[Y_{ij}|Z_j = 1] - E[Y_{ij}|Z_j = 0].
$$
We assume that three months after deworming children would have sufficiently recovered from infection to impact school attendance.  Alternatively, we could do the comparison twelve months after deworming.  

For the LATE estimation we use $Z_j$ as an instrumental variable and make the assumptions that

* $Y_{ij}(1, h) = Y_{ij}(0, h), \forall h$: school attendance is not directly effected by deworming, but only through its effect on health.
* There are three types of children:
    a) those who are always healthy, $H_{ij}(0) = H_{ij}(1) = 1$, either because they were healthy before deworming, or because they would seek deworming treatment even in the control group.
    b) those who are always infected, $H_{ij}(0) = H_{ij}(1) = 0$, because they were infected before deworming and refused treatment when offered. 
    c) and those who are vulnerable to infection, $H_{ij}(1) > H_{ij}(0)$.
    
Thus, we can estimate 
$$
  LATE = E[Y_{ij}(1, H_{ij}(1)) - Y_{ij}(0, H_{ij}(0))| H_{ij}(1) > H_{ij}(0)] = \frac{E[Y_{ij}|Z_j = 1] - E[Y_{ij}|Z_j = 0]}{E[H_{ij}|Z_j = 1] - E[H_{ij}|Z_j = 0]}.
$$

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4, message=FALSE}
prepost.sth.long.data %>% 
  filter(county %in% western.province, 
         infection.type %in% c("sth", "as", "hk")) %>%
  ddply(.(infection.type), function(df) {
    lm(high.bin ~ survey + survey.mon, data=df) %>% 
      (l(reg.res ~ {
        robust.vcov <- vcov.cluster(df, reg.res, cluster1="districtcode")
        predict.data <- expand.grid(survey=levels(df$survey)) 
        predict.rob(reg.res, vcov=robust.vcov, newdata=predict.data) %>% as.data.frame %>% cbind(predict.data)
      })) 
  }) %>%
  mutate(merr=qnorm(0.05/2, lower.tail=FALSE) * se.fit,
         fit.max=fit + merr,
         fit.min=fit - merr,
         infection.type=factor(infection.type, levels=c("as", "hk", "sth"), labels=c("Ascaris", "Hookworm", "All"))) %>%
  (l(ready.data ~ {
    dodge <- position_dodge(width=0.9) 
    ggplot(ready.data, aes(x=survey, group=infection.type)) + 
      geom_bar(aes(y=fit), stat="identity", position=dodge, alpha=0.5) +
      geom_errorbar(aes(ymin=fit.min, ymax=fit.max), position=dodge, width=0.5) +
      scale_y_continuous("Proportion of High/Moderate Intensity", limits=c(0, 0.3)) +
      scale_x_discrete("Survey") + 
      facet_wrap(~ infection.type) 
  }))
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4, message=FALSE}
hf.sth.long.data %>%
  filter(province.name == "WESTERN",
         infection.type %in% c("sth", "as", "hk"),
         sincetreat >= 0) %>%
  mutate(high.bin=ifelse(high == TRUE, 1, 0)) %>%
  d_ply(.(infection.type), function(df) {
    cat(sprintf("%s\n", df$infection.type[1]))
    try(lm(high.bin ~ sincetreat*bl.high, data=df) %>% summary %>% print) #%>% 
#       (l(reg.res ~ {
#         robust.vcov <- vcov.cluster(df, reg.res, cluster1="districtcode")
#         predict.data <- expand.grid(sincetreat=range(df$sincetreat))
#         predict.rob(reg.res, vcov=robust.vcov, newdata=predict.data) %>% as.data.frame %>% cbind(predict.data)
#       })) 
  }) 
```

# References